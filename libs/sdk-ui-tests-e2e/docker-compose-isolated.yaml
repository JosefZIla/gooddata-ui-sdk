version: "3.7"
services:
  isolated-tests:
    image: cypress/included:6.2.1
    entrypoint: node ./scripts/run_isolated_compose.js --$MODE --filter=$FILTER
    volumes:
      - ./:/gooddata-ui-sdk:rw
    working_dir: /gooddata-ui-sdk
    user: "$USER_UID:$USER_GID"
    depends_on:
      - gooddata-ui-sdk
    environment:
      - CYPRESS_HOST=http://gooddata-sdk-ui:9500
      - NPM_TOKEN
      - MODE
      - FILTER
      - NO_COLOR
      - BUILD_URL

  gooddata-ui-sdk:
    image: $IMAGE_ID
    volumes:
      - ./nginx/proxy-isolated-tests.conf:/etc/nginx/extra-conf.d/proxy-isolated-tests.conf
    depends_on:
      - backend-mock

  backend-mock:
    image: rodolpheche/wiremock
    command: "--preserve-host-header --proxy-all=https://${HOST:-staging3.intgdc.com}"
#    --extensions org.gooddata.extensions.ResponseHeadersTransformer,org.gooddata.extensions.RequestHeadersTransformer
    volumes:
      - ./recordings/:/home/wiremock:cached
      - ./recordings/wiremock_extension/:/var/wiremock/extensions:ro
    environment:
      - PROXY_HOST=https://${HOST:-staging3.intgdc.com}
